#!/usr/bin/env python

import os
import sys
import argparse
import logging

# Find spack's location and its prefix.
current_file = os.path.realpath(os.path.expanduser(__file__))
current_prefix = os.path.dirname(os.path.dirname(current_file))

# Allow spack libs to be imported in our scripts
current_lib_path = os.path.join(current_prefix, "lib")
sys.path.insert(0, current_lib_path)

import utils
import cascade_yaml_config
import log_config
from workspace import WorkspaceManager

ls=log_config.log_setup()
logging.debug("__file__:" + os.path.realpath(__file__))
ls.set_args()
mylogger = logging.getLogger(__name__)

# create the top-level parser
base_parser = argparse.ArgumentParser(prog='spack-deploy',add_help=False )
base_parser.add_argument('-c','--config_paths', action='append', help='yaml config folders', default = [os.path.join(current_prefix, 'config')])
top_config_dict = cascade_yaml_config.CascadeYamlConfig(default_paths=['config'], glob_suffix='defaults.yaml' ).conf

common_parser = argparse.ArgumentParser(prog='spack-deploy',
                                        parents=[base_parser],
                                        add_help=False,
                                        formatter_class=argparse.ArgumentDefaultsHelpFormatter  )

common_args=top_config_dict.get('argparse', dict()).get('common',dict())

cascade_yaml_config.argparse_add_arguments(common_parser,common_args)
global_args = common_parser.parse_known_args()[0]

parser = argparse.ArgumentParser(prog='spack-deploy',
                                 parents=[common_parser],
                                 formatter_class=argparse.ArgumentDefaultsHelpFormatter)
subparsers = parser.add_subparsers(help='Utility for dealing with many instances of spacks',
                                   dest='subparser_name')
subparsers.required=True

deploy_manager = WorkspaceManager("./workspace", dry_run=global_args.dry_run)
deploy_manager_subcommand = 'workspace'
deploy_manager_conf_keys = ['argparse', 'subparser', deploy_manager_subcommand]
# print(manager.__class__.__name__ + " :: " + str(manager._get_class_methods_defaults()))
deploy_manager_conf = cascade_yaml_config.get_sub_config(top_config_dict, deploy_manager_conf_keys)
# print("HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH",deploy_manager_conf)
deploy_manager._add_subparser(subparsers, name='workspace', conf=deploy_manager._get_argparse_methods(deploy_manager_conf), help='A workspace is an instance of spack')

args = parser.parse_args()
args.func(args)

